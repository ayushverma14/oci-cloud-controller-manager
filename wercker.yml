box: golang:1.9
dev:
  steps:
    - internal/shell
build:
  base-path: "/go/src/github.com/oracle/oci-cloud-controller-manager"
  steps:
#   - install-packages:
#     packages: rsync

    - script:
      name: write VERSION.txt
      code: |
        git describe --always --long --dirty > ${WERCKER_OUTPUT_DIR}/VERSION.txt

    - script:
      name: go fmt
      code: make gofmt

#   - script:
#     name: Populate cache
#     code: |
#       if [[ -d "$WERCKER_CACHE_DIR/go-pkg-cache" ]]; then
#           mkdir -p "$GOPATH/pkg/linux_amd64_static"
#           rsync -avzvt                           \
#               "$WERCKER_CACHE_DIR/go-pkg-cache/" \
#               "$GOPATH/pkg/linux_amd64_static"
#       fi

    - script:
      name: golint
      code: |
        go get -u github.com/golang/lint/golint
        make golint

    - script:
      name: go vet
      code: make govet

    - script:
      name: build
      code: make build

#   - script:
#     name: Store cache
#     code: |
#       rsync -azt                          \
#         "$GOPATH/pkg/linux_amd64_static"  \
#         "$WERCKER_CACHE_DIR/go-pkg-cache/"

    - script:
      name: unit tests
      code: make test

    - script:
      name: copy binary
      code: |
        cp dist/oci-cloud-controller-manager ${WERCKER_OUTPUT_DIR}

push:
  box:
    id: oraclelinux:7-slim
  steps:
    - script:
        name: set ENV vars
        code: |
          export VERSION=$(cat VERSION.txt)

    - script:
        name: prepare
        code: |
          mv ./oci-cloud-controller-manager /oci-cloud-controller-manager
          chmod +x /oci-cloud-controller-manager

    - internal/docker-push:
        repository: registry.oracledx.com/skeppare/oci-cloud-controller-manager
        registry: https://registry.oracledx.com/v2
        username: $DOCKER_REGISTRY_USERNAME
        password: $DOCKER_REGISTRY_PASSWORD
        tag: $VERSION
        entrypoint: /oci-cloud-controller-manager
        user: 0
